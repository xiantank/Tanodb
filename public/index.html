<!doctype html>
<html>
<head>
<title>
Data Engineering project 1 - odb
</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!--script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="//www.cs.ccu.edu.tw/~cht99u/src/bootstrap-3.3.4-dist/css/bootstrap.min.css"-->
<link rel="stylesheet" href="./style.css">
<script>
var dragSrcEl = null;
var MAXFILESIZE = 300000;
var db = "db";
function generalList( objs ){
		console.log(objs);
		for(var i in objs){
				var fileList = document.getElementById("fileList");
				var list = document.createElement('div');
				list.setAttribute("id",objs[i].filename);
				list.setAttribute("class","item-list");
				list.setAttribute("draggable","true");
				var filename = document.createElement("span");
				filename.setAttribute("class","flow-left");
				filename.innerHTML=objs[i].filename;
				var filesize = document.createElement("span");
				filesize.setAttribute("class","flow-right");
				filesize.innerHTML=objs[i].size;
				list.appendChild(filename);
				list.appendChild(filesize);
				fileList.appendChild(list);
		}
		var lists = document.querySelectorAll('.item-list');
		[].forEach.call(lists, function(list) {
						list.addEventListener('dragstart', handleDragStart, false);
						list.addEventListener('dragend', handleDragEnd, false);
						list.addEventListener('dblclick', downloadFile, false);
						//list.addEventListener('dragenter', handleDragEnter, false);
						//list.addEventListener('dragover', handleDragOver, false);
						//list.addEventListener('dragleave', handleDragLeave, false);
						//list.addEventListener('drop', handleDrop , false);
						});
		var trash = document.querySelectorAll('#trashcan').item(0);
		trash.addEventListener('drop', deleteDrop , false);
		trash.addEventListener('dragover', handleDragOver, false);
		trash.addEventListener('dragenter', handleDragEnter, false);
		trash.addEventListener('dragleave', handleDragLeave, false);

		var fileUpload = document.querySelectorAll('#fileUpload').item(0);
		fileUpload.addEventListener('drop', uploadDrop , false);
		fileUpload.addEventListener('dragover', handleDragOver, false);
		fileUpload.addEventListener('dragenter', handleDragEnter, false);
		fileUpload.addEventListener('dragleave', handleDragLeave, false);

}
function handleDragStart(e) {
		  this.style.opacity = '0.3';
		  console.log("start: "+this.firstChild.textContent);
		  dragSrcEl = this;
		  e.dataTransfer.effectAllowed = 'move';
		  //e.dataTransfer.setData('text/html', this.firstChild.textContent);
		  e.dataTransfer.setData('text/html', this.id);
}
function handleDragOver(e) {
		if (e.preventDefault) {
				e.preventDefault();
		}

		e.dataTransfer.dropEffect = 'move';
		console.log("over: "+this.id);

		return false;
}

function handleDragEnter(e) {
		e.dataTransfer.dropEffect = 'move';

		this.classList.add("over");
		console.log("enter: "+this.id);
}

function handleDragLeave(e) {
		console.log("leave: "+this.firstChild.textContent);
		this.classList.remove("over");
}
function handleDragEnd(e) {
		console.log("end: "+this.firstChild.textContent);
		this.style.opacity = '1';
}
function uploadDrop(e) {
		if (e.stopPropagation) {
				e.stopPropagation();
				e.preventDefault();
		}
		e.dataTransfer.dropEffect = 'copy';
		    
		this.classList.remove("over");
		//TODO check isFile , filesize , filename
		if(e.dataTransfer.types[0] !== 'Files'){
				return;
		}
		for(var i=0,j=e.dataTransfer.files.length; i<j; i++) {
				console.log("name: " + e.dataTransfer.files[i].name + " size: " + e.dataTransfer.files[i].size);
				if(e.dataTransfer.files[i].size > MAXFILESIZE){
						console.log("over file size limit");
						return;
				}
				var formData = new FormData();
				formData.append('file', e.dataTransfer.files[i]);
				var xhr = new XMLHttpRequest();
				xhr.open('POST', "/odb/"+db+"/put/"+e.dataTransfer.files[i].name);
				xhr.onload = function () {
						if (xhr.status === 200) {
								console.log('all done: ' + xhr.status);
						} else {
								console.log('something error @ uploadDrop.xhr.onload');
						}
				};
				xhr.onreadystatechange = function(){
						if(xhr.readyState==4){
								var tmp = xhr.responseText;
								console.log(tmp);
						}
				};

				xhr.send(formData);

		}



		return false;
}
function deleteDrop(e) {
		if (e.stopPropagation) {
				e.stopPropagation();
				e.preventDefault();
		}
		var itemId = e.dataTransfer.getData('text/html');
		e.dataTransfer.dropEffect = 'copy';

		console.log("will delete : "+ itemId);
		var el = document.getElementById(itemId);
		    
		el.parentNode.removeChild(el);
		this.classList.remove("over");
		//TODO send delete request


		return false;
}
function downloadFile(e) {
		window.location.href="/odb/"+db+"/get/"+this.id;
		console.log("dblclick");
}

</script>
</head>
<body>



<div id="fileUpload" class="fileUpload">
</div>
<div id="trashcan" class="trashcan">
</div>
<div id="fileList" class="list-block">

</div>
<script>
//$.ajax($("#listArea").);
url="/odb/db/list";
$.ajax({
	url: url,
	type:"POST",
	success: function(msg){
			console.log("sucess:"+msg);
			//try{
				generalList( JSON.parse(msg) );
			/*}catch(e){
			console.log(e);
			return;
			}*/
	},
	error: function(msg){
			console.log("error"+msg);
	}
});

</script>
</body>
</html>
