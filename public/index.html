<!doctype html>
<html>
<head>
<title>
Data Engineering project 1 - odb
</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!--script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="//www.cs.ccu.edu.tw/~cht99u/src/bootstrap-3.3.4-dist/css/bootstrap.min.css"-->
<link rel="stylesheet" href="./style.css">
<script>
var dragSrcEl = null;
var MAXFILESIZE = 512 * 1024 * 1024;
var db = "db";
var currentDir = 0;
function generalList( objs ){
		console.log(objs);
		var fileList = document.getElementById("fileList");
		if(objs.length==0){
				message("no result");
		}
		else{
				fileList.innerHTML="";

		for(var i in objs){
				var list = document.createElement('div');
				list.setAttribute("id",objs[i].rid);
				list.setAttribute("class","item-list");
				list.setAttribute("draggable","true");
				var filename = document.createElement("span");
				filename.setAttribute("class","flow-left");
				filename.innerHTML=objs[i].name;
				list.appendChild(filename);
				if(objs[i].size){
						var filesize = document.createElement("span");
						filesize.setAttribute("class","flow-right");
						filesize.innerHTML=objs[i].size;
						list.appendChild(filesize);
				}
				fileList.appendChild(list);
		}
		var lists = document.querySelectorAll('.item-list');
		[].forEach.call(lists, function(list) {
						list.addEventListener('dragstart', handleDragStart, false);
						list.addEventListener('dragend', handleDragEnd, false);
						list.addEventListener('dblclick', downloadFile, false);
						//list.addEventListener('dragenter', handleDragEnter, false);
						//list.addEventListener('dragover', handleDragOver, false);
						//list.addEventListener('dragleave', handleDragLeave, false);
						//list.addEventListener('drop', handleDrop , false);
						});
		}
		var trash = document.querySelectorAll('#trashcan').item(0);
		trash.addEventListener('drop', deleteDrop , false);
		trash.addEventListener('dragover', handleDragOver, false);
		trash.addEventListener('dragenter', handleDragEnter, false);
		trash.addEventListener('dragleave', handleDragLeave, false);

		var fileUpload = document.querySelectorAll('#fileUpload').item(0);
		fileUpload.addEventListener('drop', uploadDrop , false);
		fileUpload.addEventListener('dragover', handleDragOver, false);
		fileUpload.addEventListener('dragenter', handleDragEnter, false);
		fileUpload.addEventListener('dragleave', handleDragLeave, false);

}
function handleDragStart(e) {
		  this.style.opacity = '0.3';
		  console.log("start: "+this.firstChild.textContent);
		  dragSrcEl = this;
		  e.dataTransfer.effectAllowed = 'move';
		  //e.dataTransfer.setData('text/html', this.firstChild.textContent);
		  e.dataTransfer.setData('text/html', this.id);
}
function handleDragOver(e) {
		if (e.preventDefault) {
				e.preventDefault();
		}

		e.dataTransfer.dropEffect = 'move';
		console.log("over: "+this.id);

		return false;
}

function handleDragEnter(e) {
		e.dataTransfer.dropEffect = 'move';

		this.classList.add("over");
		console.log("enter: "+this.id);
}

function handleDragLeave(e) {
		console.log("leave: "+this.firstChild.textContent);
		this.classList.remove("over");
}
function handleDragEnd(e) {
		console.log("end: "+this.firstChild.textContent);
		this.style.opacity = '1';
}
function uploadDrop(e) {
		if (e.stopPropagation) {
				e.stopPropagation();
				e.preventDefault();
		}
		e.dataTransfer.dropEffect = 'move';
		    
		this.classList.remove("over");
		//TODO check  filesize , filename
		if(e.dataTransfer.types.indexOf('Files') == -1){
				message("not Files");
				return;
		}
		for(var i=0,j=e.dataTransfer.files.length; i<j; i++) {
				console.log("name: " + e.dataTransfer.files[i].name + " size: " + e.dataTransfer.files[i].size);
				if(e.dataTransfer.files[i].size > MAXFILESIZE){
						message("over file size limit");
						return;
				}
		}
		try{
		upload(e.dataTransfer.files,0);
		}catch(e){console.log("[error]"+e);}
		return false;
}
function upload(files,i){
		if(i>= files.length ){
				return;
		}
		var formData = new FormData();
				formData.append('file', files[i]);
				var xhr = new XMLHttpRequest();
				xhr.open('POST', "/odb/" + db+"/" + currentDir  +"/put/"+files[i].name);
				xhr.onload = function () {
						if (xhr.status === 200) {
								console.log('all done: ' + xhr.status);
						} else {
								console.log('something error @ uploadDrop.xhr.onload');
						}
				};
				xhr.onreadystatechange = function(){
						if(xhr.readyState==4){
								i++;
								upload(files,i);
								var tmp = xhr.responseText;
								message(tmp);
								showList();
						}
				};
				xhr.send(formData);

}
function deleteDrop(e) {
		if (e.stopPropagation) {
				e.stopPropagation();
				e.preventDefault();
		}
		var itemId = e.dataTransfer.getData('text/html');
		e.dataTransfer.dropEffect = 'move';

		console.log("will delete : "+ itemId);
		var el = document.getElementById(itemId);
		if(!el){
				message("not element!");
				return;
		}
		    
		el.parentNode.removeChild(el);
		this.classList.remove("over");
		//TODO send delete request
		var xhr = new XMLHttpRequest();
		//TODO check if item.type == dir => deleteDir
		xhr.open('GET', "/odb/"+db+"/delete/"+itemId);
		xhr.onload = function () {
				if (xhr.status === 200) {
						console.log('all done: ' + xhr.status);
				} else {
						console.log('something error @ deleteDrop.xhr.onload');
				}
		};
		xhr.onreadystatechange = function(){
				if(xhr.readyState==4){
						var tmp = xhr.responseText;
						message(tmp);
				}
		};

		xhr.send();



		return false;
}
function showList(){
		url="/odb/db/list/"+currentDir;
		$.ajax({
				url: url,
				type:"POST",
				success: function(msg){
				console.log("sucess:"+msg);
				try{
				generalList( JSON.parse(msg).children );
				}catch(e){
				  console.log(e);
				  return;
				  }
				},
				error: function(msg){
					console.log("[error]"+msg);
					}
					});

}

function search(){
		//TODO
		var search = document.getElementById('search').value;
		if(search === "") {
				message("can not be empty");
				return false;
		}

		url="/odb/db/search";
		var formData = {search:search};
		/*
		var formData = new FormData();
		formData.append('objsearch', search);
		*/
		$.ajax({
				url: url,
				type:"POST",
				data:formData,
				success: function(msg){
				//console.log("sucess:"+msg);
				//try{
				generalList( JSON.parse(msg) );
				/*}catch(e){
				  console.log(e);
				  return;
				  }*/
				},
				error: function(msg){
					console.log("error"+msg);
					}
					});
		return false;

}
function downloadFile(e) {
		download(this.id);
}
function download(filename){
		window.location.href="/odb/"+db+"/get/"+filename;
		console.log("dblclick");
}
function message(msg){
		var message = document.querySelectorAll('#message').item(0);

		message.innerHTML = msg;
		message.classList.remove("hid");
		setTimeout(function(){
						var message = document.querySelectorAll('#message').item(0);
						message.classList.add("hid");
		}, 3000);
		console.log(msg);


}
window.onresize = function(event) {
		//var body = document.getElementsByTagName("body");
		//body[0].style.width= screen.width+'px';
		body[0].style.width= window.innerWidth+'px';

};
</script>
</head>
<body>


<div id="topbar" class="topbar">
	<div id="fileUpload" class="fileUpload dropTarget flow-right">
		<img class="fit-image" src="./img/add.png" />
	</div>
	<span id="searchbar" class="mid searchDiv">
			<input type="input" id="search">
			<button onclick="search()" >search</button>
	</span>
	<div id="trashcan" class="trashcan dropTarget flow-right">
		<img class="fit-image" src="./img/trashcan.png" />
	</div>
</div>
<div id="fileList" class="list-block">
</div>
<div id="message" class="message hid">
</div>
<script>
showList();
body = document.getElementsByTagName("body");
body[0].style.width= window.innerWidth+'px';
		var searchText = document.querySelectorAll('#search').item(0);
		searchText.addEventListener('keyup', yo , false);
		function yo(e){
				console.log("yo");
		}
</script>
</body>
</html>
